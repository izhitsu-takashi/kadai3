<div class="dashboard-container" [class.tutorial-mode]="isTutorialMode">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="app-name">{{ appName }}</div>
      <div class="header-actions">
        <button 
          class="notification-button" 
          type="button"
          [disabled]="(selectedMenuId === 'health-insurance-settings' && isHealthInsuranceEditing) || uploadProgress.isUploading"
          (click)="toggleNotification()">
          お知らせ
          <span *ngIf="getUnreadNotificationCount() > 0" class="notification-badge">{{ getUnreadNotificationCount() }}</span>
        </button>
        <button 
          class="logout-button" 
          type="button"
          [disabled]="isLoggingOut || isHealthInsuranceSaving || (selectedMenuId === 'health-insurance-settings' && isHealthInsuranceEditing) || uploadProgress.isUploading"
          (click)="onLogout()">
          {{ isLoggingOut ? 'ログアウト中' : 'ログアウト' }}
        </button>
      </div>
    </div>
  </header>
  <div class="dashboard-body">
    <aside class="sidebar">
      <nav class="sidebar-menu">
        <ng-container *ngFor="let item of menuItems">
          <button 
            class="menu-item" 
            [class.active]="selectedMenuId === item.id || (item.id === 'settings' && (isSettingsExpanded || isSettingsSubMenuActive()))"
            type="button"
            [attr.data-id]="item.id"
            (click)="selectMenu(item.id)"
            [disabled]="uploadProgress.isUploading">
            {{ item.label }}
          </button>
          <!-- 設定のサブメニュー -->
          <div *ngIf="item.id === 'settings' && isSettingsExpanded" class="settings-submenu">
            <button 
              *ngFor="let subMenu of settingsSubMenus" 
              class="submenu-item" 
              [class.active]="isSettingsSubMenuSelected(subMenu.id)"
              [class.setup-required]="isSubMenuSetupRequired(subMenu.id)"
              type="button"
              (click)="selectSettingsSubMenu(subMenu.id)"
              [disabled]="uploadProgress.isUploading">
              {{ subMenu.label }}
            </button>
          </div>
        </ng-container>
      </nav>
    </aside>
    <main class="dashboard-content">
      <div *ngIf="selectedMenuId === 'insurance-list'" class="insurance-list-container">
        <!-- 初期データ読み込み中のローディング表示 -->
        <div *ngIf="isInitialDataLoading" class="initial-loading-overlay">
          <div class="initial-loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-message">データを読み込んでいます</p>
          </div>
        </div>
        <!-- 初期データ読み込み完了後のコンテンツ -->
        <div [class.loading-disabled]="isInitialDataLoading" class="insurance-list-content">
        <div class="filter-container">
          <div class="filter-row">
            <div class="filter-item">
              <label for="month-select" class="filter-label">表示月:</label>
              <select 
                id="month-select" 
                class="filter-select"
                [(ngModel)]="selectedMonth"
                [disabled]="isInitialDataLoading"
                (change)="onMonthChange($any($event.target).value)">
                <option *ngFor="let month of (tableType === 'salary' ? availableMonths : availableBonusMonths)" [value]="month">
                  {{ month }}
                </option>
              </select>
            </div>
            <div class="filter-item">
              <div class="table-type-selector">
                <button 
                  type="button"
                  class="table-type-button"
                  [class.active]="tableType === 'salary'"
                  [disabled]="isInitialDataLoading"
                  (click)="onTableTypeChange('salary')">
                  給与
                </button>
                <button 
                  type="button"
                  class="table-type-button"
                  [class.active]="tableType === 'bonus'"
                  [disabled]="isInitialDataLoading"
                  (click)="onTableTypeChange('bonus')">
                  賞与
                </button>
              </div>
            </div>
            <div class="filter-item">
              <button 
                type="button"
                class="column-customization-button"
                [disabled]="isInitialDataLoading"
                (click)="openColumnCustomizationModal()">
                表示列
              </button>
            </div>
            <div class="filter-item">
              <button 
                type="button"
                class="filter-customization-button"
                [disabled]="isInitialDataLoading"
                (click)="openFilterCustomizationModal()">
                フィルター
              </button>
            </div>
            <div class="filter-item">
              <button 
                type="button"
                class="csv-export-button"
                [disabled]="isInitialDataLoading"
                (click)="exportToCSV()">
                CSV出力
              </button>
            </div>
          </div>
        </div>
        <div class="table-container">
          <div *ngIf="isLoading" class="loading-message">
            <p>データを読み込み中...</p>
          </div>
          <ng-container *ngIf="!isLoading">
          <!-- 事業者負担額表示（フィルター適用後のみ表示） -->
          <div *ngIf="isFilterApplied && ((tableType === 'salary' && sortedEmployees && sortedEmployees.length > 0) || (tableType === 'bonus' && sortedBonuses && sortedBonuses.length > 0))" class="employer-burden-display">
            <div class="employer-burden-label">{{ selectedMonth }}　事業者負担額合計</div>
            <div class="employer-burden-value">{{ getEmployerBurden() | number }}円</div>
          </div>
          <!-- 給与テーブル -->
          <table *ngIf="tableType === 'salary' && employees && employees.length > 0" class="employee-table">
            <thead>
              <tr>
                <th *ngFor="let column of columns" 
                    [class.sortable-header]="column.sortable"
                    [class.non-sortable-header]="!column.sortable"
                    (click)="column.sortable && sortTable(column.key)">
                  <div class="table-header-content">
                    <span>{{ column.label }}</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let employee of sortedEmployees" (click)="!isInitialDataLoading && openEmployeeModal(employee)" class="employee-row" [class.disabled]="isInitialDataLoading">
                <td *ngFor="let column of columns">
                  <span *ngIf="column.type === 'number'">
                    {{ getColumnValue(employee, column.key) | number }}<span *ngIf="column.key.includes('料') || column.key.includes('額') || column.key.includes('給与') || column.key.includes('賞与')">円</span>
                  </span>
                  <span *ngIf="column.type === 'date'">
                    {{ formatDate(getColumnValue(employee, column.key)) }}
                  </span>
                  <span *ngIf="column.type !== 'number' && column.type !== 'date'">
                    {{ getColumnValue(employee, column.key) }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- 賞与テーブル -->
          <table *ngIf="tableType === 'bonus' && bonuses && bonuses.length > 0" class="employee-table">
            <thead>
              <tr>
                <th *ngFor="let column of columns" 
                    [class.sortable-header]="column.sortable"
                    [class.non-sortable-header]="!column.sortable"
                    (click)="column.sortable && sortTable(column.key)">
                  <div class="table-header-content">
                    <span>{{ column.label }}</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let bonus of sortedBonuses" (click)="!isInitialDataLoading && openEmployeeModal(bonus)" class="employee-row" [class.disabled]="isInitialDataLoading">
                <td *ngFor="let column of columns">
                  <span *ngIf="column.type === 'number'">
                    {{ getColumnValue(bonus, column.key) | number }}<span *ngIf="column.key.includes('料') || column.key.includes('額') || column.key.includes('給与') || column.key.includes('賞与')">円</span>
                  </span>
                  <span *ngIf="column.type === 'date'">
                    {{ formatDate(getColumnValue(bonus, column.key)) }}
                  </span>
                  <span *ngIf="column.type !== 'number' && column.type !== 'date'">
                    {{ getColumnValue(bonus, column.key) }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- <div *ngIf="!employees || employees.length === 0" class="no-data-message">
            <p>データがありません</p>
          </div> -->
          </ng-container>
        </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'company-settings'" class="settings-page-container">
        <div class="company-settings-form">
          <h2 class="form-title">企業情報設定</h2>
          <form (ngSubmit)="onCompanyInfoSubmit()" class="company-form">
            <div class="form-group">
              <label for="companyName" class="form-label">会社名（法人名）</label>
              <input 
                type="text" 
                id="companyName" 
                class="form-input"
                [(ngModel)]="companyInfo.companyName"
                name="companyName"
                [disabled]="!isCompanyInfoEditing"
                placeholder="会社名（法人名）を入力してください">
            </div>
            <div class="form-group">
              <label for="address" class="form-label">所在地（住所）</label>
              <input 
                type="text" 
                id="address" 
                class="form-input"
                [(ngModel)]="companyInfo.address"
                name="address"
                [disabled]="!isCompanyInfoEditing"
                placeholder="所在地（住所）を入力してください">
            </div>
            <div class="form-group">
              <label class="form-label">適用事業所種別</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="establishmentType" 
                    value="mandatory"
                    [(ngModel)]="companyInfo.establishmentType"
                    [disabled]="!isCompanyInfoEditing">
                  <span>強制</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="establishmentType" 
                    value="optional"
                    [(ngModel)]="companyInfo.establishmentType"
                    [disabled]="!isCompanyInfoEditing">
                  <span>任意</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">社会保険料徴収月</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="socialInsuranceCollectionMonth" 
                    value="current"
                    [(ngModel)]="companyInfo.socialInsuranceCollectionMonth"
                    [disabled]="!isCompanyInfoEditing">
                  <span>当月</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="socialInsuranceCollectionMonth" 
                    value="next"
                    [(ngModel)]="companyInfo.socialInsuranceCollectionMonth"
                    [disabled]="!isCompanyInfoEditing">
                  <span>翌月</span>
                </label>
              </div>
            </div>
            <div class="form-actions">
              <button 
                *ngIf="isCompanyInfoEditing" 
                type="submit" 
                class="submit-button">
                保存
              </button>
              <button 
                *ngIf="!isCompanyInfoEditing" 
                type="button" 
                class="edit-button"
                (click)="onEditCompanyInfo()">
                編集
              </button>
            </div>
          </form>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'health-insurance-settings'" class="settings-page-container">
        <div class="health-insurance-settings-form">
          <h2 class="form-title">健康保険設定</h2>
          <form (ngSubmit)="onHealthInsuranceSubmit()" class="health-insurance-form">
            <div class="form-group">
              <label class="form-label">健康保険種別</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="healthInsuranceType" 
                    value="kyokai"
                    [(ngModel)]="healthInsuranceType"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving"
                    (change)="onHealthInsuranceTypeChange('kyokai')">
                  <span>協会けんぽ</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="healthInsuranceType" 
                    value="kumiai"
                    [(ngModel)]="healthInsuranceType"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving"
                    (change)="onHealthInsuranceTypeChange('kumiai')">
                  <span>組合保険</span>
                </label>
              </div>
            </div>

            <!-- 協会けんぽの場合のフォーム -->
            <div *ngIf="healthInsuranceType === 'kyokai'" class="form-group">
              <label for="prefecture" class="form-label">都道府県</label>
                <select 
                id="prefecture" 
                class="form-select"
                [(ngModel)]="prefecture"
                name="prefecture"
                [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                <option value="">都道府県を選択してください</option>
                <option *ngFor="let pref of prefectures" [value]="pref">
                  {{ pref }}
                </option>
              </select>
            </div>

            <!-- 組合保険の場合のフォーム -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label for="insuranceRate" class="form-label">保険料率</label>
              <div class="insurance-rate-input-wrapper">
                <input 
                  type="text" 
                  id="insuranceRate" 
                  class="form-input"
                  [class.error]="insuranceRateError"
                  [value]="insuranceRateDisplay"
                  name="insuranceRate"
                  [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving"
                  placeholder="保険料率を入力"
                  (input)="onInsuranceRateInput($event)"
                  (blur)="onInsuranceRateBlur()">
                <span class="percentage-symbol">%</span>
              </div>
              <div *ngIf="insuranceRateError" class="error-message">
                {{ insuranceRateError }}
              </div>
            </div>

            <!-- 従業員負担の保険料折半割合変更（組合健保専用） -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label for="employeeBurdenRatio" class="form-label">従業員負担の保険料折半割合</label>
              <div class="insurance-rate-input-wrapper">
                <input 
                  type="text" 
                  id="employeeBurdenRatio" 
                  class="form-input"
                  [class.error]="employeeBurdenRatioError"
                  [value]="employeeBurdenRatioDisplay"
                  (input)="onEmployeeBurdenRatioInput($event)"
                  (blur)="onEmployeeBurdenRatioBlur()"
                  name="employeeBurdenRatio"
                  [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving"
                  placeholder="割合を入力">
                <span class="percentage-symbol">%</span>
              </div>
              <div *ngIf="employeeBurdenRatioError" class="error-message">
                {{ employeeBurdenRatioError }}
              </div>
              <p class="form-help-text">※従業員負担割合を入力してください（例：40%と入力すると、従業員負担4割、事業主負担6割で計算されます）</p>
            </div>

            <!-- 組合保険の場合の等級設定 -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label class="form-label">等級</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="gradeSettingType" 
                    value="kyokai"
                    [(ngModel)]="gradeSettingType"
                    (ngModelChange)="onGradeSettingTypeChange()"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>協会けんぽに従う</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="gradeSettingType" 
                    value="custom"
                    [(ngModel)]="gradeSettingType"
                    (ngModelChange)="onGradeSettingTypeChange()"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>カスタム</span>
                </label>
              </div>
              
              <!-- カスタムの場合の等級上限選択 -->
              <div *ngIf="gradeSettingType === 'custom'" class="form-group" style="margin-top: 15px;">
                <label for="customMaxGrade" class="form-label">最大等級</label>
                <select 
                  id="customMaxGrade" 
                  class="form-select"
                  [(ngModel)]="customMaxGrade"
                  (ngModelChange)="onCustomMaxGradeChange()"
                  name="customMaxGrade"
                  [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <option *ngFor="let option of customGradeOptions" [value]="option.grade">
                    {{ option.grade }}等級（標準報酬月額上限{{ getMonthlyStandardByGrade(option.grade) }}万円）
                  </option>
                </select>

              </div>
            </div>

            <!-- 組合保険の場合の特定被保険者の実装 -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label class="form-label">特定被保険者の実装</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="hasSpecificInsured" 
                    [value]="true"
                    [(ngModel)]="hasSpecificInsured"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>有</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="hasSpecificInsured" 
                    [value]="false"
                    [(ngModel)]="hasSpecificInsured"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>無</span>
                </label>
              </div>
            </div>

            <!-- 組合保険の場合の年間標準賞与額の上限変更 -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label class="form-label">健康保険課税対象の年間標準賞与額上限変更</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="annualBonusLimitType" 
                    value="kyokai"
                    [(ngModel)]="annualBonusLimitType"
                    (ngModelChange)="onAnnualBonusLimitTypeChange()"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>協会けんぽに従う</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="annualBonusLimitType" 
                    value="custom"
                    [(ngModel)]="annualBonusLimitType"
                    (ngModelChange)="onAnnualBonusLimitTypeChange()"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving">
                  <span>カスタム</span>
                </label>
              </div>
              
              <!-- カスタムの場合の年間標準賞与額の上限入力 -->
              <div *ngIf="annualBonusLimitType === 'custom'" class="form-group" style="margin-top: 15px;">
                <label for="customAnnualBonusLimit" class="form-label">年間標準賞与額の上限</label>
                <div class="insurance-rate-input-wrapper">
                  <input 
                    type="text" 
                    id="customAnnualBonusLimit" 
                    class="form-input"
                    [value]="customAnnualBonusLimit"
                    (input)="onCustomAnnualBonusLimitInput($event)"
                    (blur)="onCustomAnnualBonusLimitBlur()"
                    name="customAnnualBonusLimit"
                    [disabled]="!isHealthInsuranceEditing || isHealthInsuranceSaving"
                    placeholder="573">
                  <span class="percentage-symbol">万円</span>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button 
                *ngIf="isHealthInsuranceEditing" 
                type="submit" 
                class="submit-button"
                [disabled]="isHealthInsuranceSaving">
                {{ isHealthInsuranceSaving ? '保存中...' : '保存' }}
              </button>
              <button 
                *ngIf="!isHealthInsuranceEditing" 
                type="button" 
                class="edit-button"
                [disabled]="isHealthInsuranceSaving"
                (click)="onEditHealthInsurance()">
                編集
              </button>
            </div>
          </form>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'insurance-rate-inquiry'" class="settings-page-container">
        <div class="insurance-rate-inquiry-container">
          <div class="inquiry-header">
          <h2 class="inquiry-title">保険料率照会</h2>
            <button 
              *ngIf="!isInsuranceRateInquiryEditing" 
              type="button"
              class="edit-rate-button"
              (click)="onEditInsuranceRateInquiry()">
              保険料率変更
            </button>
            <button 
              *ngIf="isInsuranceRateInquiryEditing" 
              type="button"
              class="cancel-rate-button"
              (click)="onCancelInsuranceRateInquiry()">
              キャンセル
            </button>
          </div>
          <div class="rate-cards">
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">厚生年金保険料</h3>
              </div>
              <div class="rate-card-content">
                <div *ngIf="!isInsuranceRateInquiryEditing" class="rate-value-display">
                  <p class="rate-value">{{ welfarePensionRate }}%</p>
                </div>
                <div *ngIf="isInsuranceRateInquiryEditing" class="rate-value-edit">
                  <div class="insurance-rate-input-wrapper">
                    <input 
                      type="text" 
                      id="welfarePensionRate" 
                      class="form-input"
                      [value]="welfarePensionRate"
                      (input)="onWelfarePensionRateInput($event)"
                      (blur)="onWelfarePensionRateBlur()"
                      name="welfarePensionRate"
                      [disabled]="isInsuranceRateInquirySaving"
                      placeholder="料率を入力">
                    <span class="percentage-symbol">%</span>
                  </div>
                </div>
              </div>
              <div class="rate-value-note">
                <div *ngIf="!isInsuranceRateInquiryEditing">
                  <p *ngFor="let line of welfarePensionRateNote.split('\n')">{{ line }}</p>
                </div>
                <div *ngIf="isInsuranceRateInquiryEditing">
                  <textarea 
                    id="welfarePensionRateNote"
                    class="note-textarea"
                    [value]="welfarePensionRateNote"
                    (input)="onWelfarePensionRateNoteInput($event)"
                    name="welfarePensionRateNote"
                    [disabled]="isInsuranceRateInquirySaving"
                    rows="3"
                    maxlength="200"
                    placeholder="注意書きを入力"></textarea>
                  <div class="char-count">{{ welfarePensionRateNote.length }}/200</div>
                </div>
              </div>
            </div>
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">介護保険料</h3>
              </div>
              <div class="rate-card-content">
                <div *ngIf="!isInsuranceRateInquiryEditing" class="rate-value-display">
                  <p class="rate-value">{{ nursingInsuranceRate }}%</p>
                </div>
                <div *ngIf="isInsuranceRateInquiryEditing" class="rate-value-edit">
                  <div class="insurance-rate-input-wrapper">
                    <input 
                      type="text" 
                      id="nursingInsuranceRate" 
                      class="form-input"
                      [value]="nursingInsuranceRate"
                      (input)="onNursingInsuranceRateInput($event)"
                      (blur)="onNursingInsuranceRateBlur()"
                      name="nursingInsuranceRate"
                      [disabled]="isInsuranceRateInquirySaving"
                      placeholder="料率を入力">
                    <span class="percentage-symbol">%</span>
                  </div>
                </div>
              </div>
              <div class="rate-value-note">
                <div *ngIf="!isInsuranceRateInquiryEditing">
                  <p *ngFor="let line of nursingInsuranceRateNote.split('\n')">{{ line }}</p>
                </div>
                <div *ngIf="isInsuranceRateInquiryEditing">
                  <textarea 
                    id="nursingInsuranceRateNote"
                    class="note-textarea"
                    [value]="nursingInsuranceRateNote"
                    (input)="onNursingInsuranceRateNoteInput($event)"
                    name="nursingInsuranceRateNote"
                    [disabled]="isInsuranceRateInquirySaving"
                    rows="3"
                    maxlength="200"
                    placeholder="注意書きを入力"></textarea>
                  <div class="char-count">{{ nursingInsuranceRateNote.length }}/200</div>
                </div>
              </div>
            </div>
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">健康保険料</h3>
              </div>
              <div class="rate-card-content">
                <p *ngIf="healthInsuranceType === 'kumiai' && insuranceRate > 0" class="rate-value">{{ insuranceRate }}%</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && prefecture && kenpoRates[prefecture]" class="rate-value">{{ kenpoRates[prefecture].healthRate }}%</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && prefecture && !kenpoRates[prefecture]" class="rate-value-note">{{ prefecture }}</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && !prefecture" class="rate-value-note">未設定</p>
                <p *ngIf="healthInsuranceType === 'kumiai' && insuranceRate === 0" class="rate-value-note">未設定</p>
              </div>
              <div class="rate-value-note">
                <p>※健康保険料は協会けんぽの場合、都道府県によって料率が異なります。</p>
              </div>
            </div>
          </div>
          <div *ngIf="isInsuranceRateInquiryEditing" class="rate-inquiry-actions">
            <button 
              type="button"
              class="submit-button"
              [disabled]="isInsuranceRateInquirySaving"
              (click)="onSaveInsuranceRateInquiry()">
              {{ isInsuranceRateInquirySaving ? '保存中...' : '保存' }}
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'employee-settings'" class="settings-page-container">
        <div class="employee-settings-container">
          <h2 class="form-title">社員情報設定</h2>
          <p class="employee-settings-description">現在設定されている給与データ、賞与データ、等級データをJSONファイルとしてダウンロードできます。</p>
          
          <div class="download-section">
            <div class="download-card">
              <h3 class="download-card-title">給与データ</h3>
              <p class="download-card-description">現在設定されている給与データをダウンロードします。</p>
              <button 
                type="button"
                class="download-button"
                (click)="downloadSalaryData()"
                [disabled]="isDownloadingSalary">
                {{ isDownloadingSalary ? 'ダウンロード中...' : '給与データをダウンロード' }}
              </button>
              <div class="upload-section">
                <input 
                  type="file" 
                  id="salaryFileInput" 
                  accept=".json"
                  (change)="onSalaryFileSelected($event)"
                  style="display: none;">
                <label for="salaryFileInput" class="upload-button">
                  <span *ngIf="!isUploadingSalary">給与データをアップロード</span>
                  <span *ngIf="isUploadingSalary">アップロード中...</span>
                </label>
              </div>
            </div>
            
            <div class="download-card">
              <h3 class="download-card-title">賞与データ</h3>
              <p class="download-card-description">現在設定されている賞与データをダウンロードします。</p>
              <button 
                type="button"
                class="download-button"
                (click)="downloadBonusData()"
                [disabled]="isDownloadingBonus">
                {{ isDownloadingBonus ? 'ダウンロード中...' : '賞与データをダウンロード' }}
              </button>
              <div class="upload-section">
                <input 
                  type="file" 
                  id="bonusFileInput" 
                  accept=".json"
                  (change)="onBonusFileSelected($event)"
                  style="display: none;">
                <label for="bonusFileInput" class="upload-button">
                  <span *ngIf="!isUploadingBonus">賞与データをアップロード</span>
                  <span *ngIf="isUploadingBonus">アップロード中...</span>
                </label>
              </div>
            </div>
            
            <div class="download-card">
              <h3 class="download-card-title">等級データ</h3>
              <p class="download-card-description">現在設定されている等級データをダウンロードします。</p>
              <button 
                type="button"
                class="download-button"
                (click)="downloadGradeData()"
                [disabled]="isDownloadingGrade">
                {{ isDownloadingGrade ? 'ダウンロード中...' : '等級データをダウンロード' }}
              </button>
              <button 
                type="button"
                class="download-button template-button"
                (click)="downloadGradeTemplate()"
                [disabled]="isDownloadingGradeTemplate">
                {{ isDownloadingGradeTemplate ? 'ダウンロード中...' : '等級テンプレートをダウンロード' }}
              </button>
              <div class="upload-section">
                <input 
                  type="file" 
                  id="gradeFileInput" 
                  accept=".json"
                  (change)="onGradeFileSelected($event)"
                  style="display: none;">
                <label for="gradeFileInput" class="upload-button">
                  <span *ngIf="!isUploadingGrade">等級データをアップロード</span>
                  <span *ngIf="isUploadingGrade">アップロード中...</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 給与/賞与テンプレートファイル作成コンテナ -->
        <div class="template-creation-container">
          <h2 class="form-title">給与/賞与テンプレートファイル作成</h2>
          <p class="template-creation-description">給与データまたは賞与データからテンプレートファイルを作成できます。</p>
          
          <div class="template-creation-form">
            <div class="form-group">
              <label class="form-label">データ種別</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="templateDataType" 
                    value="salary"
                    [(ngModel)]="templateDataType"
                    (change)="onTemplateDataTypeChange()">
                  <span>給与</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="templateDataType" 
                    value="bonus"
                    [(ngModel)]="templateDataType"
                    (change)="onTemplateDataTypeChange()">
                  <span>賞与</span>
                </label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">作成年月</label>
              <div class="year-month-selector">
                <select 
                  class="form-input year-select"
                  [(ngModel)]="templateCreationYear"
                  [disabled]="!templateDataType">
                  <option value="">年を選択</option>
                  <option *ngFor="let year of getAvailableYears()" [value]="year">
                    {{ year }}年
                  </option>
                </select>
                <select 
                  class="form-input month-select"
                  [(ngModel)]="templateCreationMonth"
                  [disabled]="!templateDataType || !templateCreationYear">
                  <option value="">月を選択</option>
                  <option *ngFor="let month of getAvailableMonths()" [value]="month">
                    {{ month }}月
                  </option>
                </select>
              </div>
            </div>
            
            <div class="template-creation-actions">
              <button 
                type="button"
                class="template-creation-button"
                (click)="createTemplate()"
                [disabled]="!templateDataType || !templateCreationYear || !templateCreationMonth || isCreatingTemplate">
                {{ isCreatingTemplate ? '作成中...' : 'テンプレートを作成' }}
              </button>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'insurance-exemption-settings'" class="settings-page-container">
        <app-import [showOnlyExemption]="true"></app-import>
      </div>
      <div *ngIf="selectedMenuId === 'insurer-inquiry'" class="settings-page-container">
        <div class="insurer-inquiry-container">
          <h2 class="form-title">保険者情報照会</h2>
          <p class="insurer-inquiry-description">各保険の保険者種別がどのように定義されているかを説明します。</p>
          
          <div class="insurer-cards">
            <!-- 健康保険者種別 -->
            <div class="insurer-card">
              <div class="insurer-card-header">
                <h3 class="insurer-card-title">健康保険者種別</h3>
              </div>
              <div class="insurer-card-content">
                <p class="insurer-card-description">従業員の健康保険の加入状況を表す種別です。</p>
                <div class="insurer-type-list">
                  <div class="insurer-type-item">
                    <div class="insurer-type-label">通常の被保険者</div>
                    <div class="insurer-type-description">健康保険に加入している従業員。健康保険料が計算されます。</div>
                  </div>
                  <div class="insurer-type-item special">
                    <div class="insurer-type-label">健康保険被扶養者</div>
                    <div class="insurer-type-description">配偶者などの被扶養者として健康保険に加入している従業員。健康保険料は0円になります。</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 介護保険者種別 -->
            <div class="insurer-card">
              <div class="insurer-card-header">
                <h3 class="insurer-card-title">介護保険者種別</h3>
              </div>
              <div class="insurer-card-content">
                <p class="insurer-card-description">従業員の介護保険の加入状況を表す種別です。健康保険の設定によって参照する項目が異なります。</p>
                <div class="insurer-type-list">
                  <div class="insurer-type-item">
                    <div class="insurer-type-label">協会けんぽの場合</div>
                    <div class="insurer-type-description">「介護保険者種別」フィールドを参照します。</div>
                  </div>
                  <div class="insurer-type-item">
                    <div class="insurer-type-label">組合保険の場合</div>
                    <div class="insurer-type-description">「特定被保険者の実装」が「有」の場合は「介護保険者種別（組合）」フィールドを参照します。「無」の場合は「介護保険者種別」フィールドを参照します。</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 厚生年金保険者種別 -->
            <div class="insurer-card">
              <div class="insurer-card-header">
                <h3 class="insurer-card-title">厚生年金保険者種別</h3>
              </div>
              <div class="insurer-card-content">
                <p class="insurer-card-description">従業員の厚生年金保険の加入状況を表す種別です。</p>
                <div class="insurer-type-list">
                  <div class="insurer-type-item">
                    <div class="insurer-type-label">通常の被保険者</div>
                    <div class="insurer-type-description">厚生年金保険に加入している従業員。厚生年金保険料が計算されます。</div>
                  </div>
                  <div class="insurer-type-item special">
                    <div class="insurer-type-label">国民年金第3号被保険者</div>
                    <div class="insurer-type-description">配偶者の厚生年金保険の被扶養者として国民年金第3号被保険者となっている従業員。厚生年金保険料は0円になります。</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="insurer-note">
            <p class="insurer-note-title">※ 注意事項</p>
            <ul class="insurer-note-list">
              <li>保険者種別は、社員データの各フィールドに設定されている値に基づいて表示されます。</li>
              <li>保険料が0円になる種別（健康保険被扶養者、国民年金第3号被保険者）は、保険料計算時に自動的に除外されます。</li>
              <li>介護保険者種別は、健康保険設定の「健康保険種別」と「特定被保険者の実装」の設定によって参照するフィールドが変わります。</li>
            </ul>
          </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'reports'" class="reports-container">
        <div class="report-filter-container">
          <div class="report-table-type-selector">
            <button 
              type="button"
              class="report-table-type-button"
              [class.active]="reportTableType === 'salary'"
              (click)="onReportTableTypeChange('salary')">
              給与
            </button>
            <button 
              type="button"
              class="report-table-type-button"
              [class.active]="reportTableType === 'bonus'"
              (click)="onReportTableTypeChange('bonus')">
              賞与
            </button>
          </div>
          <div class="filter-type-selector">
            <label class="filter-type-label">表示単位:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="reportFilterType" 
                  value="month"
                  [checked]="reportFilterType === 'month'"
                  (change)="onReportFilterTypeChange('month')">
                <span>月単位</span>
              </label>
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="reportFilterType" 
                  value="year"
                  [checked]="reportFilterType === 'year'"
                  (change)="onReportFilterTypeChange('year')">
                <span>年度単位</span>
              </label>
            </div>
          </div>
          <div class="filter-selector">
            <label *ngIf="reportFilterType === 'month'" for="report-month-select" class="filter-label">表示月:</label>
            <label *ngIf="reportFilterType === 'year'" for="report-year-select" class="filter-label">表示年度:</label>
            <select 
              *ngIf="reportFilterType === 'month'"
              id="report-month-select" 
              class="filter-select"
              [(ngModel)]="reportSelectedMonth"
              (ngModelChange)="onReportMonthChange($event)">
              <option *ngFor="let month of (reportTableType === 'salary' ? availableMonths : availableBonusMonths)" [value]="month">
                {{ month }}
              </option>
            </select>
            <select 
              *ngIf="reportFilterType === 'year'"
              id="report-year-select" 
              class="filter-select"
              [(ngModel)]="reportSelectedYear"
              (ngModelChange)="onReportYearChange($event)">
              <option *ngFor="let year of (reportTableType === 'salary' ? availableYears : availableBonusYears)" [value]="year">
                {{ year }}年度
              </option>
            </select>
          </div>
          <button 
            type="button"
            class="pdf-create-button"
            (click)="createReportPDF()">
            PDF作成
          </button>
        </div>
        <div class="charts-container">
          <div class="chart-card">
            <h3 class="chart-title">社員負担額</h3>
            <div class="chart-wrapper">
              <canvas #personalBurdenChart></canvas>
            </div>
            <div class="chart-total">
              <p class="total-label">合計額</p>
              <p class="total-amount">{{ personalBurdenTotal.toLocaleString() }}円</p>
            </div>
          </div>
          <div class="chart-card">
            <h3 class="chart-title">会社負担額</h3>
            <div class="chart-wrapper">
              <canvas #companyBurdenChart></canvas>
            </div>
            <div class="chart-total">
              <p class="total-label">合計額</p>
              <p class="total-amount">{{ companyBurdenTotal.toLocaleString() }}円</p>
            </div>
          </div>
          <div class="chart-card">
            <h3 class="chart-title">合計保険料</h3>
            <div class="chart-wrapper">
              <canvas #totalBurdenChart></canvas>
            </div>
            <div class="chart-total">
              <p class="total-label">合計額</p>
              <p class="total-amount">{{ totalInsuranceTotal.toLocaleString() }}円</p>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="selectedMenuId !== 'insurance-list' && selectedMenuId !== 'company-settings' && selectedMenuId !== 'health-insurance-settings' && selectedMenuId !== 'employee-settings' && selectedMenuId !== 'insurance-exemption-settings' && selectedMenuId !== 'insurance-rate-inquiry' && selectedMenuId !== 'insurer-inquiry' && selectedMenuId !== 'reports'" class="page-message">
        <p>{{ getSelectedMenuLabel() }}のページです。</p>
      </div>
    </main>
  </div>
</div>

<!-- アップロード中のオーバーレイ -->
<div *ngIf="uploadProgress.isUploading" class="upload-overlay">
  <div class="upload-overlay-content">
    <div class="upload-spinner"></div>
    <h3 class="upload-title">
      <span *ngIf="uploadProgress.type === 'salary'">給与データをアップロード中</span>
      <span *ngIf="uploadProgress.type === 'bonus'">賞与データをアップロード中</span>
      <span *ngIf="uploadProgress.type === 'grade'">等級データをアップロード中</span>
    </h3>
    <p class="upload-message">{{ uploadProgress.message }}</p>
    <div class="upload-progress-bar-container">
      <div class="upload-progress-bar" [style.width.%]="uploadProgress.total > 0 ? (uploadProgress.current / uploadProgress.total * 100) : 0"></div>
    </div>
    <p class="upload-progress-text" *ngIf="uploadProgress.total > 0">
      {{ uploadProgress.current }} / {{ uploadProgress.total }} 件処理中
    </p>
  </div>
</div>

<!-- チュートリアルオーバーレイ -->
<div *ngIf="isTutorialMode" class="tutorial-overlay">
  <div class="tutorial-modal" (click)="$event.stopPropagation()">
    <div class="tutorial-header">
      <h2 class="tutorial-title">{{ getCurrentTutorialStep()?.title }}</h2>
      <button class="tutorial-close" (click)="endTutorial()" type="button">×</button>
    </div>
    <div class="tutorial-content">
      <p class="tutorial-description">{{ getCurrentTutorialStep()?.description }}</p>
      <div class="tutorial-progress">
        <span class="tutorial-step-info">
          {{ currentTutorialStep + 1 }} / {{ tutorialSteps.length }}
        </span>
      </div>
    </div>
    <div class="tutorial-footer">
      <button 
        class="tutorial-button tutorial-button-secondary" 
        (click)="previousTutorialStep()" 
        [disabled]="currentTutorialStep === 0"
        type="button">
        前へ
      </button>
      <button 
        class="tutorial-button tutorial-button-primary" 
        (click)="nextTutorialStep()" 
        type="button">
        {{ currentTutorialStep === tutorialSteps.length - 1 ? '終了' : '次へ' }}
      </button>
    </div>
  </div>
</div>

<!-- 社員情報モーダル -->
<div *ngIf="isModalOpen" class="modal-overlay" (click)="closeEmployeeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">社員情報</h2>
      <div class="modal-header-actions">
        <button class="modal-close-button" (click)="closeEmployeeModal()">×</button>
      </div>
    </div>
    <div class="modal-body" *ngIf="selectedEmployee">
      <div class="employee-info-container">
        <!-- JSONファイルの元データ -->
        <div class="info-row" *ngFor="let field of getEmployeeAllFields(selectedEmployee)">
          <span class="info-label">{{ getFieldDisplayName(field.key) }}</span>
          <span class="info-value">
            <span *ngIf="isNumericField(field.key, field.value)">
              {{ field.value | number }}<span *ngIf="field.key.includes('料') || field.key.includes('額') || field.key.includes('給与') || field.key.includes('賞与')">円</span>
            </span>
            <span *ngIf="isDateField(field.key)">{{ formatDate(field.value) }}</span>
            <span *ngIf="!isDateField(field.key) && !isNumericField(field.key, field.value)">
              {{ field.value }}
            </span>
          </span>
        </div>
        
        <!-- 計算済みフィールド（計算後の値のみ表示） -->
        <div class="info-row" *ngIf="tableType === 'salary'">
          <span class="info-label">標準報酬月額</span>
          <span class="info-value">{{ getStandardSalary(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row" *ngIf="tableType === 'salary' && getStandardSalaryCalculationBase(selectedEmployee) > 0">
          <span class="info-label">標準報酬月額算出基準給与</span>
          <span class="info-value">{{ getStandardSalaryCalculationBase(selectedEmployee) | number }}円（{{ getStandardSalaryCalculationMethod(selectedEmployee) }}）</span>
        </div>
        <div class="info-row" *ngIf="tableType === 'bonus'">
          <span class="info-label">標準賞与額</span>
          <span class="info-value">{{ getStandardBonus(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">健康保険料</span>
          <span class="info-value">{{ getHealthInsurance(selectedEmployee, tableType === 'bonus') | number:'1.0-2' }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">厚生年金保険料</span>
          <span class="info-value">{{ getWelfarePension(selectedEmployee, tableType === 'bonus') | number:'1.0-2' }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">介護保険料</span>
          <span class="info-value">{{ getNursingInsurance(selectedEmployee, tableType === 'bonus') | number:'1.0-2' }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">社員負担額</span>
          <span class="info-value">{{ getPersonalBurden(selectedEmployee, tableType === 'bonus') | number }}円</span>
        </div>
        <div class="info-row" *ngIf="tableType === 'salary'">
          <span class="info-label">健康介護保険等級</span>
          <span class="info-value">{{ getGrade(selectedEmployee) }}</span>
        </div>
        <div class="info-row" *ngIf="tableType === 'salary'">
          <span class="info-label">厚生年金保険等級</span>
          <span class="info-value">{{ getWelfarePensionGrade(selectedEmployee) > 0 ? getWelfarePensionGrade(selectedEmployee) : '-' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 表示列カスタマイズモーダル -->
<div *ngIf="isColumnCustomizationModalOpen" class="modal-overlay" (click)="closeColumnCustomizationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">表示列の選択</h2>
      <div class="modal-header-actions">
        <button class="modal-close-button" (click)="closeColumnCustomizationModal()">×</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="column-customization-container">
        <p class="column-customization-description">表示したい列にチェックを入れてください。</p>
        <div class="column-checkbox-list">
          <label *ngFor="let column of availableColumns" class="column-checkbox-item">
            <input 
              type="checkbox" 
              [(ngModel)]="column.visible"
              (change)="applyFilters()">
            <span>{{ column.label }}</span>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-button primary" (click)="closeColumnCustomizationModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- フィルターカスタマイズモーダル -->
<div *ngIf="isFilterCustomizationModalOpen" class="modal-overlay" (click)="closeFilterCustomizationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">フィルターの設定</h2>
      <div class="modal-header-actions">
        <button class="modal-close-button" (click)="closeFilterCustomizationModal()">×</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="filter-customization-container">
        <p class="filter-customization-description">フィルターを適用したい列を選択し、値を選択してください。</p>
        <div class="filter-list">
          <ng-container *ngFor="let column of availableColumns">
            <div *ngIf="column.key !== 'salary' && column.key !== '給与' && column.key !== 'bonus' && column.key !== '賞与' && 
                        column.key !== 'standardSalary' && column.key !== '標準報酬月額' && column.key !== 'standardBonus' && column.key !== '標準賞与額' && 
                        column.key !== 'healthInsurance' && column.key !== '健康保険料' && 
                        column.key !== 'welfarePension' && column.key !== '厚生年金保険料' && 
                        column.key !== 'nursingInsurance' && column.key !== '介護保険料' && 
                        column.key !== 'personalBurden' && column.key !== '社員負担額' && column.key !== '本人負担額'" class="filter-item">
              <div class="filter-item-header">
                <label class="filter-checkbox-label">
                  <input 
                    type="checkbox" 
                    [(ngModel)]="column.filterable"
                    (change)="updateFilterValues(column.key)">
                  <span>{{ column.label }}</span>
                </label>
              </div>
            <div *ngIf="column.filterable" class="filter-item-content">
              <select 
                class="filter-select"
                [ngModel]="activeCustomFilters[column.key] || ''"
                (ngModelChange)="onFilterValueChange(column.key, $event)">
                <option value="">すべて</option>
                <option *ngFor="let value of customFilters[column.key]" [value]="value">
                  {{ value }}
                </option>
              </select>
            </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-button primary" (click)="closeFilterCustomizationModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- お知らせモーダル -->
<div *ngIf="isNotificationOpen" class="notification-overlay" (click)="closeNotification()">
  <div class="notification-modal" (click)="$event.stopPropagation()">
    <div class="notification-header">
      <h3 class="notification-title">お知らせ</h3>
      <button class="notification-close" (click)="closeNotification()">×</button>
    </div>
    <div class="notification-content">
      <div *ngIf="notifications.length === 0" class="notification-empty">
        <p>お知らせはありません</p>
      </div>
      <div 
        *ngFor="let notification of notifications; let i = index" 
        class="notification-item"
        [class.notification-read]="notification.read"
        (click)="markNotificationAsRead(i)">
        <div class="notification-icon">{{ getNotificationIcon(notification.type) }}</div>
        <div class="notification-text">
          <p class="notification-message">{{ notification.message }}</p>
          <p class="notification-date">{{ formatNotificationDate(notification.date) }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 保存中オーバーレイ -->
<div *ngIf="isHealthInsuranceSaving" class="saving-overlay">
  <div class="saving-message">
    <p>保存中...</p>
  </div>
</div>
