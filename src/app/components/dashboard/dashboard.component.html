<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="app-name">{{ appName }}</div>
      <div class="header-actions">
        <button class="notification-button" type="button">お知らせ</button>
        <button 
          class="logout-button" 
          type="button"
          [disabled]="isLoggingOut"
          (click)="onLogout()">
          {{ isLoggingOut ? 'ログアウト中' : 'ログアウト' }}
        </button>
      </div>
    </div>
  </header>
  <div class="dashboard-body">
    <aside class="sidebar">
      <nav class="sidebar-menu">
        <ng-container *ngFor="let item of menuItems">
          <button 
            class="menu-item" 
            [class.active]="selectedMenuId === item.id || (item.id === 'settings' && (isSettingsExpanded || isSettingsSubMenuActive()))"
            type="button"
            [attr.data-id]="item.id"
            (click)="selectMenu(item.id)">
            {{ item.label }}
          </button>
          <!-- 設定のサブメニュー -->
          <div *ngIf="item.id === 'settings' && isSettingsExpanded" class="settings-submenu">
            <button 
              *ngFor="let subMenu of settingsSubMenus" 
              class="submenu-item" 
              [class.active]="isSettingsSubMenuSelected(subMenu.id)"
              type="button"
              (click)="selectSettingsSubMenu(subMenu.id)">
              {{ subMenu.label }}
            </button>
          </div>
        </ng-container>
      </nav>
    </aside>
    <main class="dashboard-content">
      <div *ngIf="selectedMenuId === 'insurance-list'" class="insurance-list-container">
        <div class="filter-container">
          <div class="filter-row">
            <div class="filter-item">
              <label for="month-select" class="filter-label">表示月:</label>
              <select 
                id="month-select" 
                class="filter-select"
                [value]="selectedMonth"
                (change)="onMonthChange($any($event.target).value)">
                <option *ngFor="let month of availableMonths" [value]="month">
                  {{ month }}
                </option>
              </select>
            </div>
            <div class="filter-item">
              <label for="department-filter" class="filter-label">部署:</label>
              <select 
                id="department-filter" 
                class="filter-select"
                [value]="filterDepartment"
                (change)="filterDepartment = $any($event.target).value; onFilterChange()">
                <option value="">すべて</option>
                <option *ngFor="let dept of availableDepartments" [value]="dept">
                  {{ dept }}
                </option>
              </select>
            </div>
            <div class="filter-item">
              <label for="employment-type-filter" class="filter-label">雇用形態:</label>
              <select 
                id="employment-type-filter" 
                class="filter-select"
                [value]="filterEmploymentType"
                (change)="filterEmploymentType = $any($event.target).value; onFilterChange()">
                <option value="">すべて</option>
                <option *ngFor="let type of availableEmploymentTypes" [value]="type">
                  {{ type }}
                </option>
              </select>
            </div>
            <div class="filter-item">
              <label for="nursing-insurance-filter" class="filter-label">介護保険:</label>
              <select 
                id="nursing-insurance-filter" 
                class="filter-select"
                [value]="filterNursingInsurance"
                (change)="filterNursingInsurance = $any($event.target).value; onFilterChange()">
                <option value="">すべて</option>
                <option value="with">有</option>
                <option value="without">無</option>
              </select>
            </div>
          </div>
        </div>
        <div class="table-container">
          <div *ngIf="isLoading" class="loading-message">
            <p>データを読み込み中...</p>
          </div>
          <ng-container *ngIf="!isLoading">
          <table *ngIf="employees && employees.length > 0" class="employee-table">
            <thead>
              <tr>
                <th *ngFor="let column of columns" 
                    [class.sortable-header]="column.sortable"
                    [class.non-sortable-header]="!column.sortable"
                    (click)="column.sortable && sortTable(column.key)">
                  <div class="table-header-content">
                    <span>{{ column.label }}</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let employee of sortedEmployees" (click)="openEmployeeModal(employee)" class="employee-row">
                <td>{{ getEmployeeId(employee) }}</td>
                <td>{{ getEmployeeName(employee) }}</td>
                <td>{{ getStandardSalary(employee) | number }}</td>
                <td>{{ getGrade(employee) }}</td>
                <td>{{ getHealthInsurance(employee) | number }}</td>
                <td>{{ getWelfarePension(employee) | number }}</td>
                <td>{{ getNursingInsurance(employee) | number }}</td>
                <td>{{ getPersonalBurden(employee) | number }}</td>
                <td>{{ getCompanyBurden(employee) | number }}</td>
              </tr>
            </tbody>
          </table>
          <!-- <div *ngIf="!employees || employees.length === 0" class="no-data-message">
            <p>データがありません</p>
          </div> -->
          </ng-container>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'company-settings'" class="settings-page-container">
        <div class="company-settings-form">
          <h2 class="form-title">企業情報設定</h2>
          <form (ngSubmit)="onCompanyInfoSubmit()" class="company-form">
            <div class="form-group">
              <label for="companyName" class="form-label">会社名（法人名）</label>
              <input 
                type="text" 
                id="companyName" 
                class="form-input"
                [(ngModel)]="companyInfo.companyName"
                name="companyName"
                [disabled]="!isCompanyInfoEditing"
                placeholder="会社名（法人名）を入力してください">
            </div>
            <div class="form-group">
              <label for="address" class="form-label">所在地（住所）</label>
              <input 
                type="text" 
                id="address" 
                class="form-input"
                [(ngModel)]="companyInfo.address"
                name="address"
                [disabled]="!isCompanyInfoEditing"
                placeholder="所在地（住所）を入力してください">
            </div>
            <div class="form-group">
              <label for="corporateNumber" class="form-label">法人番号</label>
              <input 
                type="text" 
                id="corporateNumber" 
                class="form-input"
                [(ngModel)]="companyInfo.corporateNumber"
                name="corporateNumber"
                [disabled]="!isCompanyInfoEditing"
                placeholder="法人番号を入力してください">
            </div>
            <div class="form-group">
              <label for="officeNumber" class="form-label">事業所番号（健康保険・厚生年金）</label>
              <input 
                type="text" 
                id="officeNumber" 
                class="form-input"
                [(ngModel)]="companyInfo.officeNumber"
                name="officeNumber"
                [disabled]="!isCompanyInfoEditing"
                placeholder="事業所番号を入力してください">
            </div>
            <div class="form-actions">
              <button 
                *ngIf="isCompanyInfoEditing" 
                type="submit" 
                class="submit-button">
                保存
              </button>
              <button 
                *ngIf="!isCompanyInfoEditing" 
                type="button" 
                class="edit-button"
                (click)="onEditCompanyInfo()">
                編集
              </button>
            </div>
          </form>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'health-insurance-settings'" class="settings-page-container">
        <div class="health-insurance-settings-form">
          <h2 class="form-title">健康保険設定</h2>
          <form (ngSubmit)="onHealthInsuranceSubmit()" class="health-insurance-form">
            <div class="form-group">
              <label class="form-label">健康保険種別</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="healthInsuranceType" 
                    value="kyokai"
                    [(ngModel)]="healthInsuranceType"
                    [disabled]="!isHealthInsuranceEditing"
                    (change)="onHealthInsuranceTypeChange('kyokai')">
                  <span>協会けんぽ</span>
                </label>
                <label class="radio-label">
                  <input 
                    type="radio" 
                    name="healthInsuranceType" 
                    value="kumiai"
                    [(ngModel)]="healthInsuranceType"
                    [disabled]="!isHealthInsuranceEditing"
                    (change)="onHealthInsuranceTypeChange('kumiai')">
                  <span>組合保険</span>
                </label>
              </div>
            </div>

            <!-- 協会けんぽの場合のフォーム -->
            <div *ngIf="healthInsuranceType === 'kyokai'" class="form-group">
              <label for="prefecture" class="form-label">都道府県</label>
              <select 
                id="prefecture" 
                class="form-select"
                [(ngModel)]="prefecture"
                name="prefecture"
                [disabled]="!isHealthInsuranceEditing">
                <option value="">都道府県を選択してください</option>
                <option *ngFor="let pref of prefectures" [value]="pref">
                  {{ pref }}
                </option>
              </select>
            </div>

            <!-- 組合保険の場合のフォーム -->
            <div *ngIf="healthInsuranceType === 'kumiai'" class="form-group">
              <label for="insuranceRate" class="form-label">保険料率</label>
              <div class="insurance-rate-input-wrapper">
                <input 
                  type="text" 
                  id="insuranceRate" 
                  class="form-input"
                  [class.error]="insuranceRateError"
                  [value]="insuranceRateDisplay"
                  name="insuranceRate"
                  [disabled]="!isHealthInsuranceEditing"
                  placeholder="保険料率を入力"
                  (input)="onInsuranceRateInput($event)"
                  (blur)="onInsuranceRateBlur()">
                <span class="percentage-symbol">%</span>
              </div>
              <div *ngIf="insuranceRateError" class="error-message">
                {{ insuranceRateError }}
              </div>
            </div>

            <div class="form-actions">
              <button 
                *ngIf="isHealthInsuranceEditing" 
                type="submit" 
                class="submit-button">
                保存
              </button>
              <button 
                *ngIf="!isHealthInsuranceEditing" 
                type="button" 
                class="edit-button"
                (click)="onEditHealthInsurance()">
                編集
              </button>
            </div>
          </form>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'insurance-rate-inquiry'" class="settings-page-container">
        <div class="insurance-rate-inquiry-container">
          <h2 class="inquiry-title">保険料率照会</h2>
          <div class="rate-cards">
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">厚生年金保険料</h3>
              </div>
              <div class="rate-card-content">
                <p class="rate-value">18.3%</p>
              </div>
            </div>
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">介護保険料</h3>
              </div>
              <div class="rate-card-content">
                <p class="rate-value">1.59%</p>
              </div>
            </div>
            <div class="rate-card">
              <div class="rate-card-header">
                <h3 class="rate-card-title">健康保険料</h3>
              </div>
              <div class="rate-card-content">
                <p *ngIf="healthInsuranceType === 'kumiai' && insuranceRate > 0" class="rate-value">{{ insuranceRate }}%</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && prefecture && kenpoRates[prefecture]" class="rate-value">{{ kenpoRates[prefecture].healthRate }}%</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && prefecture && !kenpoRates[prefecture]" class="rate-value-note">{{ prefecture }}</p>
                <p *ngIf="healthInsuranceType === 'kyokai' && !prefecture" class="rate-value-note">未設定</p>
                <p *ngIf="healthInsuranceType === 'kumiai' && insuranceRate === 0" class="rate-value-note">未設定</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId === 'employee-settings'" class="settings-page-container">
        <app-import></app-import>
      </div>
      <div *ngIf="selectedMenuId === 'reports'" class="reports-container">
        <div class="report-filter-container">
          <div class="filter-type-selector">
            <label class="filter-type-label">表示単位:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="reportFilterType" 
                  value="month"
                  [checked]="reportFilterType === 'month'"
                  (change)="onReportFilterTypeChange('month')">
                <span>月単位</span>
              </label>
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="reportFilterType" 
                  value="year"
                  [checked]="reportFilterType === 'year'"
                  (change)="onReportFilterTypeChange('year')">
                <span>年単位</span>
              </label>
            </div>
          </div>
          <div class="filter-selector">
            <label *ngIf="reportFilterType === 'month'" for="report-month-select" class="filter-label">表示月:</label>
            <label *ngIf="reportFilterType === 'year'" for="report-year-select" class="filter-label">表示年:</label>
            <select 
              *ngIf="reportFilterType === 'month'"
              id="report-month-select" 
              class="filter-select"
              [value]="reportSelectedMonth"
              (change)="onReportMonthChange($any($event.target).value)">
              <option *ngFor="let month of availableMonths" [value]="month">
                {{ month }}
              </option>
            </select>
            <select 
              *ngIf="reportFilterType === 'year'"
              id="report-year-select" 
              class="filter-select"
              [value]="reportSelectedYear"
              (change)="onReportYearChange($any($event.target).value)">
              <option *ngFor="let year of availableYears" [value]="year">
                {{ year }}年
              </option>
            </select>
          </div>
        </div>
        <div class="charts-container">
          <div class="chart-card">
            <h3 class="chart-title">社員負担額</h3>
            <div class="chart-wrapper">
              <canvas #personalBurdenChart></canvas>
            </div>
            <div class="chart-total">
              <p class="total-label">合計額</p>
              <p class="total-amount">{{ personalBurdenTotal.toLocaleString() }}円</p>
            </div>
          </div>
          <div class="chart-card">
            <h3 class="chart-title">会社負担額</h3>
            <div class="chart-wrapper">
              <canvas #companyBurdenChart></canvas>
            </div>
            <div class="chart-total">
              <p class="total-label">合計額</p>
              <p class="total-amount">{{ companyBurdenTotal.toLocaleString() }}円</p>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedMenuId !== 'insurance-list' && selectedMenuId !== 'company-settings' && selectedMenuId !== 'health-insurance-settings' && selectedMenuId !== 'employee-settings' && selectedMenuId !== 'insurance-rate-inquiry' && selectedMenuId !== 'reports'" class="page-message">
        <p>{{ getSelectedMenuLabel() }}のページです。</p>
      </div>
    </main>
  </div>
</div>

<!-- 社員情報モーダル -->
<div *ngIf="isModalOpen" class="modal-overlay" (click)="closeEmployeeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">社員情報</h2>
      <button class="modal-close-button" (click)="closeEmployeeModal()">×</button>
    </div>
    <div class="modal-body" *ngIf="selectedEmployee">
      <div class="employee-info-container">
        <div class="info-row">
          <span class="info-label">ID</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, 'ID') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">氏名</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '氏名') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">役職</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '役職') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">部署</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '部署') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">生年月日</span>
          <span class="info-value">{{ formatDate(getEmployeeField(selectedEmployee, '生年月日')) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">雇用形態</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '雇用形態') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">勤務地</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '勤務地') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">年齢</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '年齢') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">性別</span>
          <span class="info-value">{{ getEmployeeField(selectedEmployee, '性別') }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">入社日</span>
          <span class="info-value">{{ formatDate(getEmployeeField(selectedEmployee, '入社日')) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">標準報酬月額</span>
          <span class="info-value">{{ getStandardSalary(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">等級</span>
          <span class="info-value">{{ getGrade(selectedEmployee) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">健康保険料</span>
          <span class="info-value">{{ getHealthInsurance(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">厚生年金保険料</span>
          <span class="info-value">{{ getWelfarePension(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">介護保険料</span>
          <span class="info-value">{{ getNursingInsurance(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">本人負担額</span>
          <span class="info-value">{{ getPersonalBurden(selectedEmployee) | number }}円</span>
        </div>
        <div class="info-row">
          <span class="info-label">会社負担額</span>
          <span class="info-value">{{ getCompanyBurden(selectedEmployee) | number }}円</span>
        </div>
      </div>
    </div>
  </div>
</div>
